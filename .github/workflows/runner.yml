name: Build GDExtension

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - "main"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Setup clang-format
        shell: bash
        run: |
          python -m pip install clang-format
      - name: Run clang-format
        shell: bash
        run: |
          clang-format --style=file:.clang-format src/**/*.cpp src/**/*.h --dry-run --Werror || true

  build_ci:
    needs: [lint]
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: { platform: linux, arch: x86_64, os: ubuntu-latest }
            target-type: template_release
            float-precision: double
          - target: { platform: windows, arch: x86_64, os: windows-latest }
            target-type: template_release
            float-precision: single
          - target: { platform: macos, arch: universal, os: macos-latest }
            target-type: template_release
            float-precision: single
          - target: { platform: android, arch: arm64, os: ubuntu-latest }
            target-type: template_release
            float-precision: single
          - target: { platform: web, arch: wasm32, os: ubuntu-latest }
            target-type: template_release
            float-precision: double
    runs-on: ${{ matrix.target.os }}
    steps:
      # Clone this repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # Build GDExtension
      - name: ðŸ”— GDExtension Build
        uses: godotengine/godot-cpp-template/.github/actions/build@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          platform: ${{ matrix.target.platform }}
          arch: ${{ matrix.target.arch }}
          float-precision: ${{ matrix.float-precision }}
          build-target-type: ${{ matrix.target-type }}

      # Mac Sign (only for macOS on main branch)
      - name: Set macOS precision extension
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        id: macos_ext
        run: |
          if [ "${{ matrix.float-precision }}" = "double" ]; then
            echo "extension=.double" >> $GITHUB_OUTPUT
          else
            echo "extension=" >> $GITHUB_OUTPUT
          fi

      - name: Mac Sign
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        uses: godotengine/godot-cpp-template/.github/actions/sign@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          FRAMEWORK_PATH: bin/addons/godot_renik/bin/libgodot_renik.macos.${{ matrix.target-type }}${{ steps.macos_ext.outputs.extension }}.universal.framework
          SIGN_FLAGS: "--deep"
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_DEV_PASSWORD: ${{ secrets.APPLE_DEV_PASSWORD }}
          APPLE_DEV_ID: ${{ secrets.APPLE_DEV_ID }}
          APPLE_DEV_TEAM_ID: ${{ secrets.APPLE_DEV_TEAM_ID }}
          APPLE_DEV_APP_ID: ${{ secrets.APPLE_DEV_APP_ID }}

      # Upload Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Godot_RenIK-${{ matrix.target.platform }}-${{ matrix.target.arch }}-${{ matrix.float-precision }}-${{ matrix.target-type }}
          path: |
            ${{ github.workspace }}/bin/**/*.so
            ${{ github.workspace }}/bin/**/*.dll
            ${{ github.workspace }}/bin/**/*.wasm
            ${{ github.workspace }}/bin/**/*.framework/**
            ${{ github.workspace }}/bin/addons/godot_renik/godot_renik.gdextension
          if-no-files-found: error

  build_full:
    needs: [lint]
    if: github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        target:
          [
            { platform: linux, arch: x86_64, os: ubuntu-latest },
            { platform: windows, arch: x86_64, os: windows-latest },
            { platform: windows, arch: x86_32, os: windows-latest },
            { platform: macos, arch: universal, os: macos-latest },
            { platform: android, arch: arm64, os: ubuntu-latest },
            { platform: android, arch: arm32, os: ubuntu-latest },
            { platform: android, arch: x86_64, os: ubuntu-latest },
            { platform: android, arch: x86_32, os: ubuntu-latest },
            { platform: ios, arch: arm64, os: macos-latest },
            { platform: web, arch: wasm32, os: ubuntu-latest },
          ]
        target-type: [template_release]
        float-precision: [single, double]
    runs-on: ${{ matrix.target.os }}
    steps:
      # Clone this repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # Build GDExtension
      - name: ðŸ”— GDExtension Build
        uses: godotengine/godot-cpp-template/.github/actions/build@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          platform: ${{ matrix.target.platform }}
          arch: ${{ matrix.target.arch }}
          float-precision: ${{ matrix.float-precision }}
          build-target-type: ${{ matrix.target-type }}

      # Mac Sign (only for macOS on main branch)
      - name: Set macOS precision extension
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        id: macos_ext
        run: |
          if [ "${{ matrix.float-precision }}" = "double" ]; then
            echo "extension=.double" >> $GITHUB_OUTPUT
          else
            echo "extension=" >> $GITHUB_OUTPUT
          fi

      - name: Mac Sign
        if: ${{ matrix.target.platform == 'macos' && github.ref == 'refs/heads/main' }}
        uses: godotengine/godot-cpp-template/.github/actions/sign@f9564a9c8115139b9624692d39e358291f6d76ce
        with:
          FRAMEWORK_PATH: bin/addons/godot_renik/bin/libgodot_renik.macos.${{ matrix.target-type }}${{ steps.macos_ext.outputs.extension }}.universal.framework
          SIGN_FLAGS: "--deep"
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_DEV_PASSWORD: ${{ secrets.APPLE_DEV_PASSWORD }}
          APPLE_DEV_ID: ${{ secrets.APPLE_DEV_ID }}
          APPLE_DEV_TEAM_ID: ${{ secrets.APPLE_DEV_TEAM_ID }}
          APPLE_DEV_APP_ID: ${{ secrets.APPLE_DEV_APP_ID }}

      # Upload Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Godot_RenIK-${{ matrix.target.platform }}-${{ matrix.target.arch }}-${{ matrix.float-precision }}-${{ matrix.target-type }}
          path: |
            ${{ github.workspace }}/bin/**/*.so
            ${{ github.workspace }}/bin/**/*.dll
            ${{ github.workspace }}/bin/**/*.wasm
            ${{ github.workspace }}/bin/**/*.framework/**
            ${{ github.workspace }}/bin/addons/godot_renik/godot_renik.gdextension
          if-no-files-found: error

  # Merges all the build artifacts together into a single Godot_RenIK artifact.
  merge:
    runs-on: ubuntu-latest
    needs: [build_ci, build_full]
    if: always()
    steps:
      - name: Merge Artifacts
        uses: actions/upload-artifact/merge@v4
        with:
          name: Godot_RenIK
          pattern: Godot_RenIK-*
          delete-merged: true

